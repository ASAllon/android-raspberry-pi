From fb8bb46a2e63f73bc77360c7043896987feda1f4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Micha=C5=82=20Gapi=C5=84ski?= <mike@gapinski.eu>
Date: Wed, 10 Jan 2024 23:04:32 +0000
Subject: [PATCH 03/10] Revert "bootscript: Migrate to the abootcmd/load
 command"

This reverts commit 306e369c0a46d18cdb28070a50e9df4f7c791d00.
---
 platform/common/uboot.config       |  4 ++--
 platform/uboot/bootscript.cpp      | 31 +++++++++++++++++++++---------
 platform/uboot/platform_amlogic.h  |  4 ++++
 platform/uboot/platform_broadcom.h |  3 +++
 platform/uboot/platform_rockchip.h |  3 +++
 platform/uboot/platform_sunxi.h    |  3 +++
 6 files changed, 37 insertions(+), 11 deletions(-)

diff --git a/platform/common/uboot.config b/platform/common/uboot.config
index f2e255a..a15cb97 100644
--- a/platform/common/uboot.config
+++ b/platform/common/uboot.config
@@ -25,5 +25,5 @@ CONFIG_USB_GADGET_PRODUCT_NUM=0x4EE0
 CONFIG_LIBAVB=y
 CONFIG_AVB_VERIFY=y
 CONFIG_CMD_AVB=y
-# 128MiB to fit boot partitions + 16MiB for remaining stuff
-CONFIG_SYS_MALLOC_LEN=0x9000000
+# 64MiB to fit boot partition during AVB + 16MiB for remaining stuff
+CONFIG_SYS_MALLOC_LEN=0x5000000
diff --git a/platform/uboot/bootscript.cpp b/platform/uboot/bootscript.cpp
index ff216a4..cfeaf9f 100644
--- a/platform/uboot/bootscript.cpp
+++ b/platform/uboot/bootscript.cpp
@@ -123,9 +123,9 @@ FUNC_BEGIN(bootcmd_start)
  then
   FEXTENV(bootargs, " androidboot.force_normal_boot=1") ;
  fi;
- abootimg addr \$abootimg_boot_ptr \$abootimg_vendor_boot_ptr \$abootimg_init_boot_ptr
+ abootimg addr \$loadaddr \$vloadaddr \$iloadaddr
 
- adtimg addr \$abootimg_dtbo_ptr
+ adtimg addr \${dtboaddr}
 #ifdef DEVICE_HANDLE_FDT
  DEVICE_HANDLE_FDT()
 #endif
@@ -138,15 +138,15 @@ FUNC_BEGIN(bootcmd_start)
 #ifdef platform_broadcom
 #endif
  adtimg get dt --id=\$overlay_fdt_id dtb_start dtb_size overlay_fdt_index &&
- cp.b \$dtb_start \$abootimg_dtbo_ptr \$dtb_size &&
+ cp.b \$dtb_start \$dtboaddr \$dtb_size &&
  fdt resize 8192 &&
 #ifdef POSTPROCESS_FDT
  POSTPROCESS_FDT()
 #endif
- fdt apply \$abootimg_dtbo_ptr &&
+ fdt apply \$dtboaddr &&
  FEXTENV(bootargs, " androidboot.dtbo_idx=\${main_fdt_index},\${overlay_fdt_index}") ;
  /* START KERNEL */
- bootm \$abootimg_boot_ptr
+ bootm \$loadaddr
  /* Should never get here */
 FUNC_END()
 
@@ -163,10 +163,23 @@ FUNC_BEGIN(bootcmd_block)
   run bootcmd_avb;
  fi;
 
- abootimg load mmc \$mmc_bootdev boot        \$slot_name
- abootimg load mmc \$mmc_bootdev init_boot   \$slot_name
- abootimg load mmc \$mmc_bootdev vendor_boot \$slot_name
- abootimg load mmc \$mmc_bootdev dtbo        \$slot_name
+ part start mmc \$mmc_bootdev boot_\$slot_name boot_start &&
+ part size  mmc \$mmc_bootdev boot_\$slot_name boot_size
+
+ part start mmc \$mmc_bootdev init_boot_\$slot_name init_boot_start &&
+ part size  mmc \$mmc_bootdev init_boot_\$slot_name init_boot_size
+
+ part start mmc \$mmc_bootdev vendor_boot_\$slot_name vendor_boot_start &&
+ part size  mmc \$mmc_bootdev vendor_boot_\$slot_name vendor_boot_size
+
+ part start mmc \$mmc_bootdev dtbo_\$slot_name dtbo_start &&
+ part size  mmc \$mmc_bootdev dtbo_\$slot_name dtbo_size
+
+ mmc dev \$mmc_bootdev &&
+ mmc read \$loadaddr \$boot_start \$boot_size
+ mmc read \$iloadaddr \$init_boot_start \$init_boot_size
+ mmc read \$vloadaddr \$vendor_boot_start \$vendor_boot_size
+ mmc read \$dtboaddr \$dtbo_start \$dtbo_size
 FUNC_END()
 
 FUNC_BEGIN(rename_and_expand_userdata_placeholder)
diff --git a/platform/uboot/platform_amlogic.h b/platform/uboot/platform_amlogic.h
index 70d0f49..b5e5b4a 100644
--- a/platform/uboot/platform_amlogic.h
+++ b/platform/uboot/platform_amlogic.h
@@ -2,6 +2,10 @@
 
 #define PLATFORM_SETUP_ENV() \
  setenv dtbaddr 0x5000000;   \
+ setenv loadaddr 0x1000000;  \
+ setenv vloadaddr 0x6000000; \
+ setenv iloadaddr 0x8000000; \
+ setenv dtboaddr 0x4000000;  \
 
 #define PLATFORM_HANDLE_FDT() \
  adtimg get dt --id=\$main_fdt_id dtb_start dtb_size main_fdt_index && \
diff --git a/platform/uboot/platform_broadcom.h b/platform/uboot/platform_broadcom.h
index 24c40c5..47ac323 100644
--- a/platform/uboot/platform_broadcom.h
+++ b/platform/uboot/platform_broadcom.h
@@ -2,6 +2,9 @@
 
 #define PLATFORM_SETUP_ENV() \
  setenv dtbaddr 0x1fa00000;   \
+ setenv loadaddr 0x10008000;  \
+ setenv vloadaddr 0x13008000; \
+ setenv dtboaddr 0x12008000;  \
 
 /* raspberrypi vc bootloader prepare fdt based on many factors. Use this fdt instead of dtb compiled by the kernel */
 #define PLATFORM_HANDLE_FDT() \
diff --git a/platform/uboot/platform_rockchip.h b/platform/uboot/platform_rockchip.h
index f4b0e84..cf4df69 100644
--- a/platform/uboot/platform_rockchip.h
+++ b/platform/uboot/platform_rockchip.h
@@ -2,6 +2,9 @@
 
 #define PLATFORM_SETUP_ENV() \
  setenv dtbaddr 0x1fa00000;   \
+ setenv loadaddr 0x10008000;  \
+ setenv vloadaddr 0x13008000; \
+ setenv dtboaddr 0x12008000;  \
 
 #define BOOTLOADER_PARTITION_OVERRIDE() \
  EXTENV(partitions, ";name=bootloader,start=32K,size=131040K,uuid=\${uuid_gpt_bootloader}")
diff --git a/platform/uboot/platform_sunxi.h b/platform/uboot/platform_sunxi.h
index d82026f..09771f9 100644
--- a/platform/uboot/platform_sunxi.h
+++ b/platform/uboot/platform_sunxi.h
@@ -2,6 +2,9 @@
 
 #define PLATFORM_SETUP_ENV() \
  setenv dtbaddr 0x5fa00000;  \
+ setenv loadaddr 0x50008000; \
+ setenv vloadaddr 0x53008000;\
+ setenv dtboaddr 0x52008000; \
 
 #define PLATFORM_HANDLE_FDT() \
  adtimg get dt --id=\$main_fdt_id dtb_start dtb_size main_fdt_index && \
-- 
2.34.1

