From 9394d1017fa9aedbba83baa8b5bef6d05b9f359c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Micha=C5=82=20Gapi=C5=84ski?= <mike@gapinski.eu>
Date: Wed, 10 Jan 2024 23:04:16 +0000
Subject: [PATCH 01/10] Revert "bootloader: Use the boot partition to store the
 dtbs instead of dtbo"

This reverts commit 4c5843ea8ae386566b7cbbacdc5895a5603eadd4.
---
 common/base/board.mk               |   1 +
 platform/kernel/dummy.dtb          | Bin 0 -> 267 bytes
 platform/kernel/empty.dts          |  20 ++++++++++++++++++++
 platform/kernel/kernel.mk          |  27 +++++++++++++++++++++++----
 platform/tools/flash-all.sh        |   1 +
 platform/tools/gensdimg.sh         |   2 ++
 platform/tools/tools.mk            |   1 +
 platform/uboot/bootscript.cpp      |  15 ++++++++++++++-
 platform/uboot/platform_amlogic.h  |   6 +++---
 platform/uboot/platform_rockchip.h |   7 +++----
 platform/uboot/platform_sunxi.h    |   6 +++---
 11 files changed, 71 insertions(+), 15 deletions(-)
 create mode 100644 platform/kernel/dummy.dtb
 create mode 100644 platform/kernel/empty.dts

diff --git a/common/base/board.mk b/common/base/board.mk
index df1dc83..19aa1ff 100644
--- a/common/base/board.mk
+++ b/common/base/board.mk
@@ -129,6 +129,7 @@ TARGET_RECOVERY_PIXEL_FORMAT := RGBX_8888
 # Kernel build rules
 BOARD_INCLUDE_RECOVERY_DTBO := true
 BOARD_INCLUDE_DTB_IN_BOOTIMG := true
+BOARD_PREBUILT_DTBIMAGE_DIR := glodroid/configuration/platform/kernel
 BOARD_BOOT_HEADER_VERSION := 4
 BOARD_INIT_BOOT_HEADER_VERSION := 4
 ifeq ($(PRODUCT_BOARD_PLATFORM),sunxi)
diff --git a/platform/kernel/dummy.dtb b/platform/kernel/dummy.dtb
new file mode 100644
index 0000000000000000000000000000000000000000..3df27f791f28b3ddf187704f8909d77eeaa15aa9
GIT binary patch
literal 267
zcmcb>`|m9S10y#B1A_$+e*t0*AQl8-0U!neaUk9UW}y;{P%dLyQDS;-YF<fvQGR|2
zM35OsF@c!+5I$pke12JKQBGoId^|{mF)gzww>+^Z6(Y^Rn3$JRl%JUb;)3*o?B{`s
y>7c7kD=tY)0;z<k<pa_PwFo(o{n#*PNn%lYYKd+^Vo3%=a(*t5&P>WlWdHzrJuCD8

literal 0
HcmV?d00001

diff --git a/platform/kernel/empty.dts b/platform/kernel/empty.dts
new file mode 100644
index 0000000..2f78de0
--- /dev/null
+++ b/platform/kernel/empty.dts
@@ -0,0 +1,20 @@
+/dts-v1/;
+/plugin/;
+
+/{
+    fragment_root {
+        target-path = "/";
+        __overlay__ {
+            /* This section was used on AOSP v9.0 for defining first-stage fstab records */
+            firmware {
+                android {
+                    compatible = "android,firmware";
+
+                    fstab {
+                        compatible = "android,fstab";
+                    };
+                };
+            };
+        };
+    };
+};
diff --git a/platform/kernel/kernel.mk b/platform/kernel/kernel.mk
index bc68a59..d49b729 100644
--- a/platform/kernel/kernel.mk
+++ b/platform/kernel/kernel.mk
@@ -64,7 +64,10 @@ $(KERNEL_TARGET): $(KERNEL_DEFCONFIG) $(KERNEL_FRAGMENTS) $(KERNEL_SRC_FILES) $(
 TARGET_VENDOR_MODULES   := $(TARGET_OUT_VENDOR_DLKM)/lib/modules
 ANDROID_DTS_OVERLAY	?= $(LOCAL_PATH)/empty.dts
 
-DTB_OUTPUT		:= $(PRODUCT_OUT)/dtb.img
+ANDROID_DTBO		:= $(PRODUCT_OUT)/obj/GLODROID/DTBO/fstab-android-sdcard.dtbo
+BOARD_PREBUILT_DTBOIMAGE := $(PRODUCT_OUT)/boot_dtbo.img
+MKDTBOIMG		:= $(HOST_OUT_EXECUTABLES)/mkdtboimg
+GEN_DTBCFG		:= $(PRODUCT_OUT)/gen/DTBO/dtbo.cfg
 
 $(TARGET_VENDOR_MODULES)/modules.dep: $(KERNEL_TARGET)
 	rm -rf $(TARGET_VENDOR_MODULES)/kernel
@@ -79,9 +82,25 @@ $(PRODUCT_OUT)/kernel: $(KERNEL_TARGET) $(TARGET_VENDOR_MODULES)/modules.dep
 
 $(PRODUCT_OUT)/vendor_dlkm.img: $(TARGET_VENDOR_MODULES)/modules.dep
 
-$(DTB_OUTPUT): $(KERNEL_TARGET)
-	echo cat $(foreach dtb,$(KERNEL_DTB_FILE) $(KERNEL_DTB_FILES),$(AOSP_TOP_ABS)/$(KERNEL_DTB_OUT)/$(dtb) ) > $@
-	cat $(foreach dtb,$(KERNEL_DTB_FILE) $(KERNEL_DTB_FILES),$(AOSP_TOP_ABS)/$(KERNEL_DTB_OUT)/$(dtb) ) > $@
+#-------------------------------------------------------------------------------
+$(ANDROID_DTBO): $(ANDROID_DTS_OVERLAY)
+	rm -f $@
+	./prebuilts/misc/linux-x86/dtc/dtc -@ -I dts -O dtb -o $@ $<
+
+ifeq ($(GD_NO_DEFAULT_GEN_DTBCFG),)
+$(GEN_DTBCFG):
+	mkdir -p $(dir $@)
+	echo "# DTBO image configuration file for GloDroid project. Autogenerated, do not change!" > $@
+	echo "  page_size=4096" >> $@
+	echo "$(AOSP_TOP_ABS)/$(KERNEL_DTB_OUT)/$(KERNEL_DTB_FILE)" >> $@
+	echo "  id=0x00000100" >> $@
+	echo "$(AOSP_TOP_ABS)/$(ANDROID_DTBO)" >> $@
+	echo "  id=0x00000FFF" >> $@
+endif
+
+$(BOARD_PREBUILT_DTBOIMAGE): $(GEN_DTBCFG) $(ANDROID_DTBO) $(KERNEL_TARGET) $(MKDTBOIMG)
+	$(call pretty,"Target dtb image: $@")
+	$(MKDTBOIMG) cfg_create $@ $<
 
 #-------------------------------------------------------------------------------
 
diff --git a/platform/tools/flash-all.sh b/platform/tools/flash-all.sh
index 768ad59..9286e61 100755
--- a/platform/tools/flash-all.sh
+++ b/platform/tools/flash-all.sh
@@ -21,6 +21,7 @@ set -x
 ./fastboot flash boot            boot.img
 ./fastboot flash init_boot       init_boot.img
 ./fastboot flash vendor_boot     vendor_boot.img
+./fastboot flash dtbo_a          boot_dtbo.img
 ./fastboot flash vbmeta_a        vbmeta.img
 ./fastboot flash vbmeta_system_a vbmeta_system.img
 ./fastboot erase misc
diff --git a/platform/tools/gensdimg.sh b/platform/tools/gensdimg.sh
index 36a0ac9..7842ca0 100755
--- a/platform/tools/gensdimg.sh
+++ b/platform/tools/gensdimg.sh
@@ -78,6 +78,8 @@ gen_image() {
     ${PARTED_TOOL} add_partition ${BASE_ARGS} --partition-name=init_boot_b           --size=8M
     ${PARTED_TOOL} add_image     ${BASE_ARGS} --partition-name=vendor_boot_a         --size=32M  --img-file=vendor_boot.img
     ${PARTED_TOOL} add_partition ${BASE_ARGS} --partition-name=vendor_boot_b         --size=32M
+    ${PARTED_TOOL} add_image     ${BASE_ARGS} --partition-name=dtbo_a                --size=8M   --img-file=boot_dtbo.img
+    ${PARTED_TOOL} add_partition ${BASE_ARGS} --partition-name=dtbo_b                --size=8M
     ${PARTED_TOOL} add_image     ${BASE_ARGS} --partition-name=vbmeta_a              --size=512K --img-file=vbmeta.img
     ${PARTED_TOOL} add_partition ${BASE_ARGS} --partition-name=vbmeta_b              --size=512K
     ${PARTED_TOOL} add_image     ${BASE_ARGS} --partition-name=vbmeta_system_a       --size=512K --img-file=vbmeta_system.img
diff --git a/platform/tools/tools.mk b/platform/tools/tools.mk
index 5cc43cb..b178ca2 100644
--- a/platform/tools/tools.mk
+++ b/platform/tools/tools.mk
@@ -24,6 +24,7 @@ DEPLOY_FILES := \
 	$(PRODUCT_OUT)/flash-sd.sh \
 	$(PRODUCT_OUT)/deploy-sd.img \
 	$(PRODUCT_OUT)/boot.img \
+	$(PRODUCT_OUT)/boot_dtbo.img \
 	$(PRODUCT_OUT)/init_boot.img \
 	$(PRODUCT_OUT)/vendor_boot.img \
 	$(PRODUCT_OUT)/super.img \
diff --git a/platform/uboot/bootscript.cpp b/platform/uboot/bootscript.cpp
index a1e2537..dc1ffeb 100644
--- a/platform/uboot/bootscript.cpp
+++ b/platform/uboot/bootscript.cpp
@@ -16,7 +16,8 @@ PLATFORM_SETUP_ENV()
 #error PLATFORM_SETUP_ENV is not defined
 #endif
 
-setenv dtb_index 0x0
+setenv    main_fdt_id 0x100
+setenv overlay_fdt_id 0xFFF
 
 /* EMMC cards have 512k erase block size. Align partitions accordingly to avoid issues with erasing. */
 
@@ -35,6 +36,8 @@ EXTENV(partitions, ";name=init_boot_a,size=8M,uuid=\${uuid_gpt_init_boot_a}")
 EXTENV(partitions, ";name=init_boot_b,size=8M,uuid=\${uuid_gpt_init_boot_b}")
 EXTENV(partitions, ";name=vendor_boot_a,size=32M,uuid=\${uuid_gpt_vendor_boot_a}")
 EXTENV(partitions, ";name=vendor_boot_b,size=32M,uuid=\${uuid_gpt_vendor_boot_b}")
+EXTENV(partitions, ";name=dtbo_a,size=8M,uuid=\${uuid_gpt_dtbo_a}")
+EXTENV(partitions, ";name=dtbo_b,size=8M,uuid=\${uuid_gpt_dtbo_b}")
 EXTENV(partitions, ";name=vbmeta_a,size=512K,uuid=\${uuid_gpt_vbmeta_a}")
 EXTENV(partitions, ";name=vbmeta_b,size=512K,uuid=\${uuid_gpt_vbmeta_b}")
 EXTENV(partitions, ";name=vbmeta_system_a,size=512K,uuid=\${uuid_gpt_vbmeta_system_a}")
@@ -122,6 +125,7 @@ FUNC_BEGIN(bootcmd_start)
  fi;
  abootimg addr \$abootimg_boot_ptr \$abootimg_vendor_boot_ptr \$abootimg_init_boot_ptr
 
+ adtimg addr \$abootimg_dtbo_ptr
 #ifdef DEVICE_HANDLE_FDT
  DEVICE_HANDLE_FDT()
 #endif
@@ -130,9 +134,17 @@ FUNC_BEGIN(bootcmd_start)
 #else
 #error PLATFORM_HANDLE_FDT is not defined
 #endif
+
+#ifdef platform_broadcom
+#endif
+ adtimg get dt --id=\$overlay_fdt_id dtb_start dtb_size overlay_fdt_index &&
+ cp.b \$dtb_start \$abootimg_dtbo_ptr \$dtb_size &&
+ fdt resize 8192 &&
 #ifdef POSTPROCESS_FDT
  POSTPROCESS_FDT()
 #endif
+ fdt apply \$abootimg_dtbo_ptr &&
+ FEXTENV(bootargs, " androidboot.dtbo_idx=\${main_fdt_index},\${overlay_fdt_index}") ;
  /* START KERNEL */
  bootm \$abootimg_boot_ptr
  /* Should never get here */
@@ -147,6 +159,7 @@ FUNC_BEGIN(bootcmd_block)
  abootimg load mmc \$mmc_bootdev boot        \${slot_name}
  abootimg load mmc \$mmc_bootdev init_boot   \${slot_name}
  abootimg load mmc \$mmc_bootdev vendor_boot \${slot_name}
+ abootimg load mmc \$mmc_bootdev dtbo        \${slot_name}
 
  if test STRESC(\$androidrecovery) = STRESC("true");
  then
diff --git a/platform/uboot/platform_amlogic.h b/platform/uboot/platform_amlogic.h
index bfe948a..70d0f49 100644
--- a/platform/uboot/platform_amlogic.h
+++ b/platform/uboot/platform_amlogic.h
@@ -4,9 +4,9 @@
  setenv dtbaddr 0x5000000;   \
 
 #define PLATFORM_HANDLE_FDT() \
- abootimg get dtb --index=\$dtb_index dtb_start dtb_size && \
- cp.b \$dtb_start \$dtbaddr \$dtb_size &&                   \
- fdt addr \$dtbaddr &&                                      \
+ adtimg get dt --id=\$main_fdt_id dtb_start dtb_size main_fdt_index && \
+ cp.b \$dtb_start \$dtbaddr \$dtb_size &&                              \
+ fdt addr \$dtbaddr &&                                                 \
 
 #define BOOTLOADER_PARTITION_OVERRIDE() \
  EXTENV(partitions, ";name=bootloader,start=512,size=2096640,uuid=\${uuid_gpt_bootloader}")
diff --git a/platform/uboot/platform_rockchip.h b/platform/uboot/platform_rockchip.h
index b4d6f00..f4b0e84 100644
--- a/platform/uboot/platform_rockchip.h
+++ b/platform/uboot/platform_rockchip.h
@@ -7,11 +7,10 @@
  EXTENV(partitions, ";name=bootloader,start=32K,size=131040K,uuid=\${uuid_gpt_bootloader}")
 
 #define POSTPROCESS_FDT() \
- fdt resize 8192                    && \
  fdt rsvmem add 0x8000000 0x8000000 && \
  fdt rsvmem print &&                   \
 
 #define PLATFORM_HANDLE_FDT() \
- abootimg get dtb --index=\$dtb_index dtb_start dtb_size && \
- cp.b \$dtb_start \$dtbaddr \$dtb_size &&                   \
- fdt addr \$dtbaddr &&                                      \
+ adtimg get dt --id=\$main_fdt_id dtb_start dtb_size main_fdt_index && \
+ cp.b \$dtb_start \$dtbaddr \$dtb_size &&                              \
+ fdt addr \$dtbaddr &&                                                 \
diff --git a/platform/uboot/platform_sunxi.h b/platform/uboot/platform_sunxi.h
index 61f329c..d82026f 100644
--- a/platform/uboot/platform_sunxi.h
+++ b/platform/uboot/platform_sunxi.h
@@ -4,6 +4,6 @@
  setenv dtbaddr 0x5fa00000;  \
 
 #define PLATFORM_HANDLE_FDT() \
- abootimg get dtb --index=\$dtb_index dtb_start dtb_size && \
- cp.b \$dtb_start \$dtbaddr \$dtb_size &&                   \
- fdt addr \$dtbaddr &&                                      \
+ adtimg get dt --id=\$main_fdt_id dtb_start dtb_size main_fdt_index && \
+ cp.b \$dtb_start \$dtbaddr \$dtb_size &&                              \
+ fdt addr \$dtbaddr &&                                                 \
-- 
2.34.1

