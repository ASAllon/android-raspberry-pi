From 1bc0c404db9ff0aef3815679437e6137ddbf6b54 Mon Sep 17 00:00:00 2001
From: "jenkins@teslaandroid.com" <jenkins@teslaandroid.com>
Date: Fri, 19 May 2023 08:14:40 +0000
Subject: [PATCH] Configurable offline mode
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Change-Id: I2724c97f88d1744e74f3dcc51e001244a854dac6
Signed-off-by: Michał Gapiński <mike@gapinski.eu>
---
 server/TetherController.cpp | 44 +++++++++++++++++++++++++++++++++++++
 1 file changed, 44 insertions(+)

diff --git a/server/TetherController.cpp b/server/TetherController.cpp
index 79193574..abaf5a11 100644
--- a/server/TetherController.cpp
+++ b/server/TetherController.cpp
@@ -125,6 +125,15 @@ bool inBpToolsMode() {
     return !strcmp(BP_TOOLS_MODE, bootmode);
 }
 
+int get_system_property_int(const char* prop_name) {
+  char prop_value[PROPERTY_VALUE_MAX];
+  if (property_get(prop_name, prop_value, nullptr) > 0) {
+    return atoi(prop_value);
+  } else {
+    return -1;
+  }
+}
+
 }  // namespace
 
 auto TetherController::iptablesRestoreFunction = execIptablesRestoreWithOutput;
@@ -223,6 +232,10 @@ int TetherController::startTethering(bool usingLegacyDnsProxy, int num_addrs, ch
         return -res;
     }
 
+    int offlineModeEnabled = get_system_property_int("persist.tesla-android.offline-mode.is_enabled");
+    int offlineModeTelemetryEnabled = get_system_property_int("persist.tesla-android.offline-mode.telemetry.is_enabled");
+    int offlineModeTeslaFirmwareDownload = get_system_property_int("persist.tesla-android.offline-mode.tesla-firmware-downloads");
+
     // Set parameters
     Fwmark fwmark;
     fwmark.netId = NetworkController::LOCAL_NET_ID;
@@ -234,6 +247,8 @@ int TetherController::startTethering(bool usingLegacyDnsProxy, int num_addrs, ch
 
     std::vector<const std::string> argVector = {
             "/system/bin/dnsmasq",
+	    "--address=/gapinski.eu/100.64.255.1",
+	    "--address=/gapinski.com/100.64.255.1",
             "--keep-in-foreground",
             "--no-resolv",
             "--no-poll",
@@ -257,6 +272,35 @@ int TetherController::startTethering(bool usingLegacyDnsProxy, int num_addrs, ch
                                          dhcp_ranges[addrIndex + 1]));
     }
 
+    argVector.push_back("--address=/www.youtu.be/100.64.255.1");
+    argVector.push_back("--address=/fullscreen.app.teslaandroid.com/100.64.255.1");
+    argVector.push_back("--address=/www.fullscreen.app.teslaandroid.com/100.64.255.1");
+    argVector.push_back("--address=/app.teslaandroid.com/100.64.255.1");
+    argVector.push_back("--address=/www.app.teslaandroid.com/100.64.255.1");
+
+
+    if(offlineModeEnabled == 1) {
+	argVector.push_back("--address=/connman.vn.tesla.services/100.64.255.1");
+        argVector.push_back("--address=/www.teslamotors.com/100.64.255.1");
+        argVector.push_back("--address=/hermes-prd.vn.tesla.services/100.64.255.1");
+        argVector.push_back("--address=/connman.vn.cloud.tesla.cn/100.64.255.1");
+        argVector.push_back("--address=/www.tesla.cn/100.64.255.1");
+        argVector.push_back("--address=/hermes-prd.vn.cloud.tesla.cn/100.64.255.1");
+	if(offlineModeTelemetryEnabled == 0) {
+	    argVector.push_back("--address=/telemetry-prd.vn.tesla.services/100.64.255.1");
+	    argVector.push_back("--address=/telemetry-prd.ap.tesla.services/100.64.255.1");
+	    argVector.push_back("--address=/apf-api.prd.vn.cloud.tesla.com/100.64.255.1");
+	    argVector.push_back("--address=/x1.ap.tesla.services/100.64.255.1");
+	    argVector.push_back("--address=/s3.ap.tesla.services/100.64.255.1");
+	    argVector.push_back("--address=/tesla-hermes-snapshot-eu.s3-eu-central-1.amazonaws.com/100.64.255.1");
+	    argVector.push_back("--address=/tesla-hermes-snapshot.s3-us-west-2.amazonaws.com/100.64.255.1");
+	}
+	if(offlineModeTeslaFirmwareDownload == 0) {
+	    argVector.push_back("--address=/va.teslamotors.com/100.64.255.1");
+	}
+    }
+
+
     std::vector<char*> args(argVector.size() + 1);
     for (unsigned i = 0; i < argVector.size(); i++) {
         args[i] = (char*)argVector[i].c_str();
-- 
2.34.1

